rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // User profiles
    match /users/{userId} {
      // Any authenticated user can read user profiles (for friend search)
      allow read: if request.auth != null;
      // Only the user themselves can write to their profile
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Wishlist items
      match /wishlist/{itemId} {
        // Any authenticated user can read (friends need to view wishlists)
        allow read: if request.auth != null;
        // Only the owner can create, update, or delete their wishlist items
        allow write: if request.auth != null && request.auth.uid == userId;
        
        // Gift status (The "Surprise" logic)
        // This subcollection tracks who is getting which gift
        match /gift_status/{statusId} {
          // Only friends (NOT the owner) can read/write gift status
          // This prevents the wishlist owner from seeing who is getting them what
          allow read, write: if request.auth != null && request.auth.uid != userId;
        }
      }
      
      // Friends subcollection
      match /friends/{friendId} {
        // Only the owner can read and write their friends list
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
